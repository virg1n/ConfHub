{% extends "base_new.html" %}

{% block title %}{{ repo.name }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="card mb-4" style="background-color: #1f1f1f; border: none; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);">
        <div class="card-body">
            <h2 class="card-title text-light">{{ repo.name }}</h2>
            <h6 class="card-subtitle mb-3 text-muted">Author: <span class="text-info">{{ author }}</span></h6>
            <p class="card-text text-light"><strong>Created at:</strong> {{ repo.created_time | datetimeformat }}</p>
            <div class="d-flex align-items-center mb-3">
                <form action="{{ url_for('like_repository', repo_id=repo.repository_id) }}" method="POST">
                    {% if has_liked %}
                        <button type="submit" class="btn btn-danger btn-sm">
                            <i class="bi bi-heart-fill"></i> Unlike
                        </button>
                    {% else %}
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-heart"></i> Like
                        </button>
                    {% endif %}
                </form>
                <span class="ms-2 text-light">{{ like_count }} {{ 'Like' if like_count == 1 else 'Likes' }}</span>
            </div>

            <!-- Display Diagram if exists -->
            {% if diagram %}
                <div class="mb-3">
                    <h5 class="text-light">Repository Diagram</h5>
                    <img src="{{ url_for('get_diagram', repo_id=repo.repository_id) }}" alt="Repository Diagram" class="img-fluid rounded">
                </div>
            {% endif %}

            <!-- Description -->
            <div class="mb-3">
                <h5 class="text-light">Description</h5>
                <p class="text-light">{{ description }}</p>
                {% if repo.is_description_ai_generated %}
                    <small class="text-info">Description generated by AI</small>
                {% else %}
                    <small class="text-secondary">Manually provided description</small>
                {% endif %}
            </div>

            <!-- Files -->
            <div class="mb-4">
                <h5 class="text-light">Files</h5>
                {% if files %}
                    <ul class="list-group">
                        {% for file in files %}
                            <li class="list-group-item d-flex justify-content-between align-items-center" style="background-color: #1e1e1e; border: 1px solid #333;">
                                <a href="{{ url_for('view_file', username=author, repo_name=repo.name, file_id=file.id) }}" class="text-info">{{ file.filename }}</a>
                                <div>
                                    <a href="{{ url_for('download_file', file_id=file.id) }}" class="btn btn-sm btn-outline-primary me-2" style="color: white;">Download</a>
                                    {% if current_user.get_id()|int == repo.user_id %}
                                        <form action="{{ url_for('delete_file', file_id=file.id) }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                            <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                                        </form>
                                    {% endif %}
                                </div>
                            </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    <p class="text-muted">No files uploaded yet.</p>
                {% endif %}
            </div>

            <!-- Download Entire Repository as ZIP -->
            <div class="mb-4">
                <a href="{{ url_for('download_repo_zip', repo_id=repo.repository_id) }}" class="btn btn-success">Download Repository as ZIP</a>
            </div>

            <!-- Edit Options (Only for Owner) -->
            {% if current_user.get_id()|int == repo.user_id %}
                <div class="accordion" id="editOptionsAccordion">
                    <!-- Add Files -->
                    <div class="accordion-item" style="background-color: #1e1e1e; border: none;">
                        <h2 class="accordion-header" id="headingAddFiles">
                            <button class="accordion-button collapsed text-light" style="background-color: #292929;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAddFiles" aria-expanded="false" aria-controls="collapseAddFiles">
                                Add Files
                            </button>
                        </h2>
                        <div id="collapseAddFiles" class="accordion-collapse collapse" aria-labelledby="headingAddFiles" data-bs-parent="#editOptionsAccordion">
                            <div class="accordion-body">
                                <form method="POST" enctype="multipart/form-data">
                                    <input type="hidden" name="action" value="add_files">
                                    <div class="mb-3">
                                        <label for="files" class="form-label text-light">Select Files</label>
                                        <input class="form-control" type="file" id="files" name="files" multiple required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Upload Files</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Update Description -->
                    <div class="accordion-item" style="background-color: #1e1e1e; border: none;">
                        <h2 class="accordion-header" id="headingUpdateDescription">
                            <button class="accordion-button collapsed text-light" style="background-color: #292929;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpdateDescription" aria-expanded="false" aria-controls="collapseUpdateDescription">
                                Update Description
                            </button>
                        </h2>
                        <div id="collapseUpdateDescription" class="accordion-collapse collapse" aria-labelledby="headingUpdateDescription" data-bs-parent="#editOptionsAccordion">
                            <div class="accordion-body">
                                <form method="POST">
                                    <input type="hidden" name="action" value="update_description">
                                    <div class="mb-3">
                                        <label for="description" class="form-label text-light">Description</label>
                                        <textarea class="form-control" id="description" name="description" rows="4" required>{{ description }}</textarea>
                                    </div>
                                    <div class="form-check mb-3">
                                        <input class="form-check-input" type="checkbox" value="on" id="use_ai" name="use_ai">
                                        <label class="form-check-label text-light" for="use_ai">
                                            Regenerate Description Using AI
                                        </label>
                                    </div>
                                    <button type="submit" class="btn btn-success">Update Description</button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Update Diagram -->
                    <div class="accordion-item" style="background-color: #1e1e1e; border: none;">
                        <h2 class="accordion-header" id="headingUpdateDiagram">
                            <button class="accordion-button collapsed text-light" style="background-color: #292929;" type="button" data-bs-toggle="collapse" data-bs-target="#collapseUpdateDiagram" aria-expanded="false" aria-controls="collapseUpdateDiagram">
                                Update Diagram
                            </button>
                        </h2>
                        <div id="collapseUpdateDiagram" class="accordion-collapse collapse" aria-labelledby="headingUpdateDiagram" data-bs-parent="#editOptionsAccordion">
                            <div class="accordion-body">
                                <form method="POST" enctype="multipart/form-data">
                                    <input type="hidden" name="action" value="update_diagram">
                                    <div class="mb-3">
                                        <label for="diagram" class="form-label text-light">Select Diagram</label>
                                        <input class="form-control" type="file" id="diagram" name="diagram" required>
                                    </div>
                                    <button type="submit" class="btn btn-primary">Upload Diagram</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

</div>
{% endblock %}
